<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Traffic Incident Dashboard</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- CSS -->
    <link rel="stylesheet" href="style.css">
    <!-- CDN WebSocket Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

</head>
<body>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="icon">üö¶</span>
                <h1>Incident Reporter</h1>
            </div>
            <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                <div class="theme-toggle-track">
                    <div class="theme-toggle-thumb">
                        <span class="theme-toggle-icon">üåô</span>
                    </div>
                </div>
            </div>
            <div class="status" id="connection-status">
                <span class="dot"></span> Connecting...
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            
            <!-- Alert Section (Dynamic) -->
            <div id="latest-alert" class="alert-banner hidden">
                <div class="alert-content">
                    <h2 id="alert-title">üî• ACCIDENT DETECTED!</h2>
                    <p id="alert-desc">A severe collision involving 2 cars was detected at Camera-01.</p>
                </div>
                <button class="close-btn" onclick="dismissAlert()">Dismiss</button>
            </div>

            <!-- Stats/Filters (Optional) -->
            <div class="stats-bar">
                <div class="stat-card">
                    <h3>Total Incidents</h3>
                    <p id="count-total">0</p>
                </div>
                <div class="stat-card">
                    <h3>Today</h3>
                    <p id="count-today">0</p>
                </div>
            </div>

            <!-- Video Upload & Analysis Section -->
            <div class="video-upload-section">
                <h2>Analyze Video Footage</h2>
                
                <div class="upload-controls">
                    <!-- Mode Switcher - Tab Style -->
                    <div class="mode-tabs" style="margin-bottom: 20px; width: 100%;">
                        <button id="mode-upload-btn" class="tab-btn active" onclick="switchMode('upload')">
                            <span class="tab-icon">‚ö°</span>
                            <span>Batch Analysis</span>
                        </button>
                        <button id="mode-live-btn" class="tab-btn" onclick="switchMode('live')">
                            <span class="tab-icon">‚ñ∂Ô∏è</span>
                            <span>Real-time Stream</span>
                        </button>
                    </div>

                    <div id="upload-input-section" class="file-input-wrapper">
                        <input type="file" id="video-input" accept="video/*" class="file-input" onchange="previewFile()">
                    </div>

                    <!-- Model Selection -->
                    <!-- Model Selection -->
                    <div id="model-selection-container" class="hidden" style="margin-top: 15px; text-align: center; width: 100%;">
                        <label for="model-select" style="margin-right: 10px; color: var(--text-secondary);">AI Model:</label>
                        <div class="input-group" style="display: inline-block;">
                        <select id="model-select">
                            <option value="small">üöÄ Standard (Small - Fast)</option>
                            <option value="medium" selected>‚öñÔ∏è Premium (Medium - Balanced)</option>
                        </select>
                    </div>
                    </div>
                    
                    <!-- Confidence Threshold Slider with Tooltip -->
                    <div id="confidence-container" style="margin-top: 15px; text-align: center; width: 100%; position: relative;">
                        <label for="conf-threshold" style="color: var(--text-secondary); font-size: 0.9rem;">
                            Confidence: 
                            <span id="conf-value" style="color: var(--accent-orange); font-weight: bold;">0.70</span>
                            <button class="tooltip-btn" onmouseenter="showTooltip()" onmouseleave="hideTooltip()" onclick="toggleTooltip()">?</button>
                        </label>
                        <div id="confidence-tooltip" class="tooltip hidden">
                            <strong>Confidence Threshold</strong><br>
                            X√°c ƒë·ªãnh m·ª©c ƒë·ªô ch·∫Øc ch·∫Øn t·ªëi thi·ªÉu (0-100%) ƒë·ªÉ AI b√°o c√°o ph√°t hi·ªán. 
                            Gi√° tr·ªã cao h∆°n gi·∫£m c·∫£nh b√°o sai nh∆∞ng c√≥ th·ªÉ b·ªè l·ª° m·ªôt s·ªë s·ª± c·ªë.
                        </div>
                        <br/>
                        <input type="range" id="conf-threshold" min="0.1" max="1.0" step="0.05" value="0.70" 
                               style="width: 80%; cursor: pointer; accent-color: var(--accent-orange);"
                               oninput="document.getElementById('conf-value').innerText = this.value">
                    </div>
                    
                    <!-- Auto Report Option -->
                    <div id="auto-report-container" style="margin-top: 15px; text-align: center; width: 100%;">
                        <label style="color: var(--text-secondary); font-size: 0.9rem; cursor: pointer;">
                            <input type="checkbox" id="auto-report" checked style="cursor: pointer; margin-right: 8px; transform: scale(1.2);">
                            <span style="vertical-align: middle;">üìù T·ª± ƒë·ªông t·∫°o b√°o c√°o AI sau khi ph√¢n t√≠ch</span>
                        </label>
                    </div>
                    
                    <!-- Single Action Button - changes based on mode -->
                    <div id="analysis-options" class="hidden" style="margin-top: 20px; display: flex; gap: 15px; justify-content: center; width: 100%;">
                         <button id="analyze-btn" type="button" class="action-btn batch-btn" onclick="startCurrentModeAnalysis()">
                            <span class="btn-icon" id="analyze-btn-icon">‚ö°</span>
                            <span id="analyze-btn-text">Start Analysis</span>
                         </button>
                    </div>
                </div>
                
                <!-- NEW: Live Stream Section (Hidden by default) -->
                <div id="live-stream-section" class="video-preview-box hidden" style="text-align: center;">
                    <h3 style="color: var(--accent-orange); margin-bottom: 10px;">üî¥ LIVE WIRELESS FEED</h3>
                    <div style="border: 2px solid var(--accent-orange); display: inline-block; overflow: hidden; border-radius: 8px;">
                        <!-- The source will be set by JS when active to save bandwidth -->
                        <!-- WebRTC Video Element -->
                        <video id="webrtc-video" autoplay playsinline controls muted style="width: 100%; max-width: 800px; display: block; background: #000;"></video>
                    </div>
                    <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.7;">Streaming from Python Server (Camera 0)</p>
                    
                    <!-- NEW: Live Snapshots Gallery -->
                    <div id="live-snapshot-gallery" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:15px; justify-content:center;">
                        <!-- Images injected by JS -->
                    </div>

                    <!-- NEW: Live Report Section -->
                    <div id="live-report-section" class="hidden" style="margin-top: 20px; border-top: 1px solid #444; padding-top: 20px;">
                        <button id="btn-create-live-report" class="btn-primary" onclick="generateLiveReport()" style="background: var(--accent-blue); padding: 10px 20px;">
                            üìù Create Live Report
                        </button>
                    </div>

                    <!-- Live Report Container (Hidden by default) -->
                    <div id="live-report-container" class="hidden" style="margin-top: 15px; padding: 15px; background: var(--card-bg); border-radius: 8px; text-align: left;">
                         <h4 style="color: var(--accent-blue);">üìã Live Session Report</h4>
                         <div id="live-report-content" style="white-space: pre-wrap; margin-top: 10px; color: var(--text-primary);"></div>
                    </div>
                </div>

                <!-- 1. Input Preview (Hidden until file selected) -->
                <div id="video-preview-container" class="video-preview-box hidden">
                    <div class="video-label">Original Footage Monitor</div>
                    <video id="input-video-preview" controls width="100%">
                        <source src="" type="video/mp4">
                    </video>
                </div>

                <!-- 2. Processing Status (Hidden until analyzing) -->
                <div id="processing-status" class="hidden" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span id="status-text" style="color: var(--accent-orange); font-weight: 600;">Initializing AI...</span>
                        <span class="spinner"></span>
                    </div>
                    <div class="progress-container">
                        <div id="progress-bar" class="progress-bar" style="width: 0%">0%</div>
                    </div>
                </div>

                <!-- 3. Result Output (Hidden until complete) -->
                <div id="video-result" class="video-result hidden">
                    <h3>‚úÖ Analysis Complete</h3>
                    
                    <!-- NEW: Create Report Button (Initial State) -->
                     <div id="create-report-section" style="text-align: center; margin-bottom: 20px;">
                        <button id="btn-create-report" class="btn-primary" onclick="generateAIReport()" style="background: var(--accent-blue); padding: 12px 24px; font-size: 1.1rem;">
                            üìù Create AI Report
                        </button>
                    </div>

                    <!-- NEW: Loading State for Report -->
                    <div id="report-loading" class="hidden" style="text-align: center; margin: 20px 0;">
                        <div class="spinner" style="width: 40px; height: 40px; border-width: 4px; margin: 0 auto;"></div>
                        <p style="margin-top: 10px; color: var(--accent-blue);">Generating comprehensive analysis...</p>
                    </div>

                    <!-- AI Report Section (Hidden until generated) -->
                    <div id="ai-report-container" class="hidden" style="margin-bottom: 15px; padding: 20px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">
                            <h2 style="color: var(--accent-blue); margin: 0;">üìã Incident Report</h2>
                            <button onclick="exportToPDF()" class="btn-secondary" style="font-size: 0.9rem;">‚¨áÔ∏è Export PDF</button>
                        </div>
                        
                        <div id="report-content" style="text-align: left;">
                            <h4 style="color: var(--text-secondary); margin-bottom: 5px;">Summary</h4>
                            <!-- Summary view (collapsed by default) -->
                            <div id="ai-report-summary" style="font-size: 1rem; line-height: 1.6; color: var(--text-primary); margin-bottom: 10px;"></div>
                            <!-- Full report (hidden by default) -->
                            <p id="ai-report-text" class="hidden" style="font-size: 1rem; line-height: 1.6; white-space: pre-wrap; color: var(--text-primary);"></p>
                            <button id="toggle-report-btn" class="read-more-btn" onclick="toggleFullReport()" style="font-size: 0.95rem; margin-top: 8px;">
                                Xem chi ti·∫øt b√°o c√°o ‚ñº
                            </button>
                        </div>
                        
                        <!-- Embedded Snapshots for PDF -->
                         <div id="report-snapshots" style="display:flex; gap:10px; margin-top:20px; justify-content:center; flex-wrap: wrap;">
                            <!-- Cloned images will go here for the PDF view -->
                        </div>
                    </div>

                    <div class="video-preview-box" style="margin-top: 10px;">
                         <!-- Reuse style for consistency -->
                        <video id="processed-video" controls width="100%" autoplay style="border-radius: 8px; border: 1px solid #444;">
                            <source src="" type="video/webm">
                            Your browser does not support the video tag.
                        </video>
                        
                        <!-- Display Snapshots -->
                        <div id="snapshot-gallery" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:15px; justify-content:center;">
                            <!-- Images injected by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feed -->
            <div class="feed-section">
                <h2>Live Incident Feed</h2>
                <div class="incident-list" id="incident-list">
                    <!-- Items will be injected here via JS -->
                    <!-- Example Item
                    <div class="incident-card">
                        <img src="https://via.placeholder.com/150" alt="Snapshot">
                        <div class="info">
                            <span class="badge badge-accident">Accident</span>
                            <span class="time">10:45 AM</span>
                            <p class="description">Gemini Description here...</p>
                            <span class="location">üìç Camera-01</span>
                        </div>
                    </div>
                    -->
                </div>
            </div>

        </main>
    </div>

    <!-- Lightbox Modal -->
    <div id="lightbox-modal" class="lightbox-modal">
        <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
        <img class="lightbox-content" id="lightbox-img">
    </div>

    <script src="app.js"></script>
</body>
</html>
